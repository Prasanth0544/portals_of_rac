// frontend/src/services/StateStore.ts
// IndexedDB-based state persistence for browser refresh survival

const DB_NAME = 'RACAdminState';
const DB_VERSION = 1;
const STORE_NAME = 'appState';
const STATE_KEY = 'currentState';

// State interface
export interface PersistedState {
    currentPage: string;
    journeyStarted: boolean;
    autoInitAttempted: boolean;
    timestamp: number;
}

// Open IndexedDB connection
const openDB = (): Promise<IDBDatabase> => {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => {
            console.error('[StateStore] Failed to open IndexedDB:', request.error);
            reject(request.error);
        };

        request.onsuccess = () => {
            resolve(request.result);
        };

        request.onupgradeneeded = (event) => {
            const db = (event.target as IDBOpenDBRequest).result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'key' });
                console.log('[StateStore] Created object store:', STORE_NAME);
            }
        };
    });
};

// Debounce timer for saves
let saveTimeout: ReturnType<typeof setTimeout> | null = null;
const DEBOUNCE_MS = 500;

/**
 * Save app state to IndexedDB (debounced to avoid excessive writes)
 */
export const saveAppState = async (state: Omit<PersistedState, 'timestamp'>): Promise<void> => {
    // Clear previous pending save
    if (saveTimeout) {
        clearTimeout(saveTimeout);
    }

    // Debounce the save
    saveTimeout = setTimeout(async () => {
        try {
            const db = await openDB();
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);

            const stateToSave: PersistedState & { key: string } = {
                key: STATE_KEY,
                ...state,
                timestamp: Date.now()
            };

            store.put(stateToSave);

            tx.oncomplete = () => {
                console.log('[StateStore] State saved:', state.currentPage, '| journeyStarted:', state.journeyStarted);
                db.close();
            };

            tx.onerror = () => {
                console.error('[StateStore] Save failed:', tx.error);
                db.close();
            };
        } catch (error) {
            console.error('[StateStore] Failed to save state:', error);
        }
    }, DEBOUNCE_MS);
};

/**
 * Load app state from IndexedDB
 */
export const loadAppState = async (): Promise<PersistedState | null> => {
    try {
        const db = await openDB();

        return new Promise((resolve) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.get(STATE_KEY);

            request.onsuccess = () => {
                const result = request.result;
                db.close();

                if (result) {
                    // Check if state is stale (older than 24 hours)
                    const ageMs = Date.now() - (result.timestamp || 0);
                    const maxAgeMs = 24 * 60 * 60 * 1000; // 24 hours

                    if (ageMs > maxAgeMs) {
                        console.log('[StateStore] State expired, clearing...');
                        clearAppState();
                        resolve(null);
                        return;
                    }

                    console.log('[StateStore] State restored:', result.currentPage, '| journeyStarted:', result.journeyStarted);
                    resolve(result as PersistedState);
                } else {
                    console.log('[StateStore] No saved state found');
                    resolve(null);
                }
            };

            request.onerror = () => {
                console.error('[StateStore] Load failed:', request.error);
                db.close();
                resolve(null);
            };
        });
    } catch (error) {
        console.error('[StateStore] Failed to load state:', error);
        return null;
    }
};

/**
 * Clear persisted state (call on logout/reset)
 */
export const clearAppState = async (): Promise<void> => {
    try {
        const db = await openDB();
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        store.delete(STATE_KEY);

        tx.oncomplete = () => {
            console.log('[StateStore] State cleared');
            db.close();
        };

        tx.onerror = () => {
            console.error('[StateStore] Clear failed:', tx.error);
            db.close();
        };
    } catch (error) {
        console.error('[StateStore] Failed to clear state:', error);
    }
};
